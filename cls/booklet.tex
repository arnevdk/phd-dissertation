\RequirePackage[T1]{fontenc}
\RequirePackage{afterpage}
\RequirePackage{float}
\RequirePackage{ragged2e}
\RequirePackage{fancyhdr}
\RequirePackage{tocloft}
\RequirePackage[font={small, sf},labelfont=bf]{caption}
\RequirePackage{titlesec}
\RequirePackage{multicol}
\RequirePackage{amssymb}
\RequirePackage{xstring}

% Set page size ================================================================
\RequirePackage[paperheight=240mm,paperwidth=160mm,bottom=30mm]{geometry}


% Full page figure =============================================================



% Custom command to position the caption in the bottom-right

\setlength{\fullpagefigwidth}{\paperwidth}
\newcommand{\fullpagefig}[3][caption.south, anchor.center]{%
    \afterpage{%
       \clearpage
       \pagecolor{lightgray} % Set background color
       \pagestyle{empty}    % Remove headers/footers
       % Begin the figure
       \begin{figure}[H]
            \centering
            \begin{tikzpicture}[remember picture, overlay]  % Overlay environment
              % Place the figure content (image, TikZ, PGFPlot, etc.)
              \IfSubStr{#1}{anchor.north}{%
                \node[anchor=north,inner sep=1cm] (image) at (current page.north) {#2};
              }{%
                \node[anchor=center,inner sep=0] (image) at (current page.center) {#2};
              }

                % Overlay caption
              \IfSubStr{#1}{caption.north}{%
                 \node[
                     anchor=north west,
                     text width=0.5\paperwidth,
                     inner sep=1cm,
                 ] at (current page.north west) {%
                   \justifying#3
                 };
              }{%
                 \node[
                     anchor=south west,
                     text width=0.5\paperwidth,
                     inner sep=1cm,
                 ] at (current page.south west) {%
                   \justifying#3
                 };
              }
            \end{tikzpicture}
       \end{figure}
       \clearpage
       \pagecolor{white}  % Reset background color to white for next pages
       \pagestyle{plain}  % Reset to default page style
       \clearpage
    }
}

% Setup font ===================================================================


% Sans-serif family: Open Sans
\RequirePackage[scale=.8]{opensans}
\renewcommand{\sffamily}{\opensans}

% Math font: Latin Modern
\RequirePackage{lmodern}   % Use Latin Modern (default) for math mode

% Serif font: Garamond
%\RequirePackage{ebgaramond-maths}
\RequirePackage{ebgaramond}


% Setup titles
\titleformat{\part}[display]{%
  \pagecolor{lightgray}\vskip10em\bfseries
}{%
  \sffamily\Large\partname\	\thepart
}{10pt}{\Huge}[\afterpage{\nopagecolor}]
\titleformat{\chapter}[display]{\bfseries}{\sffamily\Large\chaptertitlename\ \thechapter}{10pt}{\Huge}
\titleformat{\section}{\sffamily\Large\bfseries}{\thesection}{1em}{}
\titleformat{\subsection}{\sffamily\large\bfseries}{\thesubsection}{1em}{}
\titleformat{\subsubsection}{\sffamily\bfseries}{\thesubsubsection}{1em}{}
\titleformat{\paragraph}[runin]{\sffamily\bfseries}{\theparagraph}{1em}{}

\titlespacing*{\section}{0pt}{1.25em}{.25em}
\titlespacing*{\subsection}{0pt}{1.25em}{.25em}
\titlespacing*{\subsubsection}{0pt}{1em}{.25em}

%\titlespacing*{\subsubsection}{0pt}{1em}{0pt}
\renewcommand{\paragraph}[1]{\noindent\textbf{\sffamily#1} }
% Setup captions
\captionsetup{justification=justified,singlelinecheck=off}

% Set bibliography font size
\renewcommand*{\bibfont}{\small}


% Equation labels
\makeatletter
\renewcommand{\tagform@}[1]{\maketag@@@{\textsf{(#1)}}}
\makeatother

% Setup pagestyle ==============================================================

% Capture part and chapter title
\newcommand*\parttitle{}
\let\origpart\part%
\renewcommand*{\part}[2][]{%
	\ifx\\#1\\% optional argument not present?
	\origpart{#2}%
		\renewcommand*\parttitle{#2}%
	\else
	\origpart[#1]{#2}%
		\renewcommand*\parttitle{#1}%
	\fi
}

\renewcommand{\chaptermark}[1]{\markboth{\thechapter\hskip 1em #1}{}}
\newcommand{\PartmarkHead}{
	\ifx\parttitle\empty\else\partname\ \thepart:\ \parttitle\fi
}
% Setup header
\fancypagestyle{front}{%
	\fancyhf{} % clear all header and footer fields
	\fancyhead[RO]{\sffamily\thepage\hfill}%
	\fancyhead[LE]{\sffamily\hfill\thepage}%
}
\fancypagestyle{main}{%
	\fancyhf{} % clear all header and footer fields
	\fancyhead[RO]{\sffamily\thepage\hfill\PartmarkHead}%
	\fancyhead[LE]{\sffamily\leftmark\hfill\thepage}%
}
\fancypagestyle{plain}{%
	\fancyhf{} % clear all header and footer fields
}
\renewcommand{\headrulewidth}{0pt}

\let\oldfrontmatter\frontmatter
\renewcommand{\frontmatter}{\oldfrontmatter\pagestyle{front}}
\let\oldbackmatter\backmatter
\renewcommand{\backmatter}{\oldbackmatter\pagestyle{front}}
\let\oldmainmatter\mainmatter
\renewcommand{\mainmatter}{\oldmainmatter\pagestyle{main}}

\setlength{\headheight}{13.6pt} % Adjust as per the warning

% Setup tables==================================================================

% Setup ToC
\renewcommand\cftpartfont{\sffamily\bfseries}
\renewcommand\cftpartpagefont{\sffamily\bfseries}
\renewcommand\cftchapfont{\sffamily}
\renewcommand\cftchappagefont{\sffamily}
\renewcommand\cftsecfont{\sffamily\small}
\renewcommand\cftsecpagefont{\sffamily}
\renewcommand\cftsubsecfont{\sffamily\small}
\renewcommand\cftsubsecpagefont{\sffamily}
\makeatletter
\renewcommand\@cftmaketoctitle{\chapter{\contentsname}}
\makeatother
%\setcounter{tocdepth}{1}
\setcounter{secnumdepth}{3} % Number down to subsubsection level

% Setup LoF
\renewcommand\cftfigfont{\sffamily\small}
\renewcommand\cftfigpagefont{\sffamily\small}
\makeatletter
\renewcommand\@cftmakeloftitle{\chapter{\listfigurename}}
\makeatother

% Setup LoT
\renewcommand\cfttabfont{\sffamily\small}
\renewcommand\cfttabpagefont{\sffamily\small}
\makeatletter
\renewcommand\@cftmakelottitle{\chapter{\listtablename}}
\makeatother

\renewcommand{\publicationnote}[1]{\noindent\emph{\sffamily#1}}
\raggedbottom
